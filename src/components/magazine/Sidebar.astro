---
export interface Props {
  publicationTitle: string;
  issueInfo: string;
  coverImg: string;
  link?: string;
  storiesRead?: string;
  percentRead?: number | string;
  bgColor?: string;
  alt?: string;
  // Optional: progressColor?: string;
}

const {
  pub = 'pilot',
  publicationTitle,
  issueInfo = 'Latest Issue',
  coverImg,
  link = "/magazine/issue",
  storiesRead = "12/18",
  percentRead = 35,
  bgColor = "#001d3d",
  alt = "Cover",
} = Astro.props;

const computedTitle =
  (typeof publicationTitle === 'string' && publicationTitle.trim() !== '')
    ? publicationTitle.trim()
    : (pub === 'turbine' ? 'Pilot Turbine Magazine' : 'Pilot Magazine');

const computedIssue =
  (typeof issueInfo === 'string' && issueInfo.trim() !== '')
    ? issueInfo.trim()
    : 'Latest Issue';

const computedCover =
  (typeof coverImg === 'string' && coverImg.trim() !== '')
    ? coverImg.trim()
    : (pub === 'turbine'
        ? '/images/proxy/turbine-mag.jpg'
        : '/images/proxy/pilot-mag.jpg');

const computedCoverFallback =
  (typeof coverFallback === 'string' && coverFallback.trim() !== '')
    ? coverFallback.trim()
    : (pub === 'turbine' ? '/images/proxy/turbine-mag.jpg' : '/images/proxy/pilot-mag.jpg');

const normalizePercent = (v: number | string): number => {
  if (typeof v === 'number') return v;
  const n = v.trim().endsWith('%') ? parseFloat(v) : parseFloat(v);
  return Number.isFinite(n) ? n : 0;
};
const pct = Math.min(100, Math.max(0, normalizePercent(percentRead)));
const width = `${pct}%`;
---

<aside
  aria-labelledby="mag-sidebar-title"
  class="mag-sidebar text-white text-center p-4 md:p-6 flex flex-col md:sticky md:top-[75px] md:self-start md:h-[calc(100vh-75px)] md:items-center"
  style={`background-color:${bgColor}; background-image:linear-gradient(transparent, rgba(0,0,0,.15));`}
>
  <span id="mag-sidebar-title" class="sr-only">Issue sidebar</span>

  <!-- Mobile condensed layout -->
  <div class="md:hidden flex items-center gap-4">
    <img src="/images/ui/logo-small-white.svg" alt="" aria-hidden="true" class="logo h-10 w-auto md:h-12" />
    <div class="flex-1 text-left">
      <div class="text-xs uppercase tracking-widest">{computedTitle}</div>
      <div class="text-xs font-light">{computedIssue}</div>
    </div>

    {(computedCover || computedCoverFallback) ? (
      <img
        src={computedCover ?? computedCoverFallback}
        data-fallback={computedCoverFallback}
        onerror="this.onerror=null; this.src=this.dataset.fallback"
        alt={alt}
        class="cover-img h-16 w-auto rounded shadow"
        loading="lazy"
        decoding="async"
      />
    ) : (
      <div class="h-16 aspect-[3/4] rounded shadow bg-white/10" aria-label="Cover image placeholder"></div>
    )}
  </div>

  <!-- Desktop vertical layout -->
  <div class="hidden md:flex md:flex-col md:items-center md:text-center">
    <img src="/images/ui/logo-small-white.svg" alt="" aria-hidden="true" class="logo px-10 block my-6 h-12 w-auto" />
    <div class="text-sm uppercase tracking-widest mb-1">{computedTitle}</div>
    <div class="text-sm font-light tracking-wide mb-4">{issueInfo}</div>

    {(computedCover || computedCoverFallback) ? (
      <a href={link}>
        <img
          src={computedCover ?? computedCoverFallback}
          data-fallback={computedCoverFallback}
          onerror="this.onerror=null; this.src=this.dataset.fallback"
          alt={alt}
          class="cover-img rounded shadow-lg mt-8"
          loading="lazy"
          decoding="async"
          width="1200"
          height="1600"
          sizes="(min-width: 768px) 280px, 30vw"
        />
      </a>
    ) : (
      <div class="rounded shadow-lg mt-8 aspect-[3/4] w-[280px] bg-white/10" aria-label="Cover image placeholder"></div>
    )}

    <p class="mt-12">
      {storiesRead}<br />stories read
    </p>

    <div class="w-full px-6 my-2">
      <div
        class="w-full h-4 bg-gray-300 rounded-full shadow-inner relative overflow-hidden"
        role="progressbar"
        aria-label="Reading progress"
        aria-valuemin="0" aria-valuemax="100" aria-valuenow={pct}
      >
        <div
          class="h-full rounded-full shadow-[0_2px_4px_rgba(0,0,0,0.3)] bg-[#00bcd4]"
          style={`width:${width};`}
        ></div>
      </div>
    </div>
  </div>
</aside>
