---
import type { APIContext } from 'astro';
import { parseVideo } from '@/lib/video/parse';

const { post } = Astro.props as { post: any };
const media = parseVideo(post?.videoUrl);
const poster = post?.featuredImage?.node?.sourceUrl;
const alt = post?.featuredImage?.node?.altText || post?.title || 'Video';
---

<article class="mx-auto max-w-4xl px-4 md:px-6 lg:px-8">
  <header class="mx-auto max-w-3xl">
    <h1 class="mt-6 text-3xl font-bold tracking-tight md:text-4xl">
      {post.title}
    </h1>
    <p class="mt-2 text-sm text-slate-500">
      {new Date(post.date).toLocaleDateString()}
    </p>
  </header>

  <section class="mt-6">
    {
      media?.kind === 'youtube' && (
        <div class="aspect-video w-full overflow-hidden rounded-2xl shadow">
          <iframe
            class="h-full w-full"
            src={`https://www.youtube.com/embed/${media.id}`}
            title={alt}
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          />
        </div>
      )
    }
    {
      media?.kind === 'vimeo' && (
        <div class="aspect-video w-full overflow-hidden rounded-2xl shadow">
          <iframe
            class="h-full w-full"
            src={`https://player.vimeo.com/video/${media.id}`}
            title={alt}
            loading="lazy"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
          />
        </div>
      )
    }
    {
      media?.kind === 'mp4' && (
        <div class="w-full overflow-hidden rounded-2xl shadow">
          <video
            class="w-full h-auto"
            controls
            preload="metadata"
            poster={poster}
          >
            <source src={media.url} type="video/mp4" />
            Your browser does not support HTML5 video.
          </video>
        </div>
      )
    }
    {
      !media && poster && (
        <div class="mt-2">
          <img
            class="w-full rounded-2xl shadow"
            src={poster}
            alt={alt}
            loading="lazy"
          />
        </div>
      )
    }
  </section>

  <section class="prose prose-slate prose-lg mt-8 max-w-none prose-headings:scroll-mt-24">
    <div set:html={post.content} />
  </section>
</article>
