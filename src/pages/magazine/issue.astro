---
// src/pages/magazine/[slug].astro
import Layout from '../../layouts/Layout.astro';
import { fetchMagazinePosts } from '../../lib/fetchPosts.js';

const posts = await fetchMagazinePosts();


// Use ACF fields to categorize the stories
const heroStory = posts.find(
  post => post.magazinePresentationOptions?.presentationslots?.includes('hero')
);

console.log({
  title: heroStory.title,
  line1: heroStory.heroTitleLine1,
  line2: heroStory.heroTitleLine2
});

const featuredStories = posts.filter(
  post => post.magazinePresentationOptions?.presentationslots?.includes('featured')
);

const teaserStories = posts.filter(
  post => post.magazinePresentationOptions?.presentationslots?.includes('teaser')
);

const line1 = heroStory.magazinePresentationOptions?.heroTitleLine1 ?? story.title;
const line2 = heroStory.magazinePresentationOptions?.heroTitleLine2 ?? '';



const { proseStyle = 'prose-magazine' } = Astro.props;

---
<Layout section="magazine">
  <div class={`grid grid-cols-1 md:grid-cols-[250px_1fr] min-h-screen relative ${proseStyle}`}>
    <aside class="relative bg-[#00677f]  flex flex-col items-center text-white text-center">
      <div class="sticky top-[75px] p-6">
        <img src="/images/ui/logo-small-white.svg" alt="Logo" class="px-10 block dark:hidden my-6" />
        <div class="text-sm uppercase tracking-widest mb-1">Pilot Magazine</div>
        <div class="text-sm font-light tracking-wide mb-4">Feb 2025 | No. 178</div>
        <img src="/images/cover.jpg" alt="Cover" class="rounded shadow-lg mt-8" />

        <p class="mt-12">12/18 <br> stories read</p>      
        <div class="w-full px-6 my-2">
          <div class="w-full h-4 bg-gray-300 rounded-full shadow-inner relative overflow-hidden">
            <div
              class="h-full w-[35%] bg-[#00bcd4] rounded-full shadow-[0_2px_4px_rgba(0,0,0,0.3)]"
            ></div>
          </div>
        </div>

      </div>
    </aside>


    <section class="bg-black text-white">
      <!-- Hero -->
      {heroStory && (
        <section
          class="relative flex items-center bg-cover bg-center text-white rounded shadow-lg p-6 min-h-[540px]"
          style={`background-image: url('${heroStory.featuredImage?.node?.sourceUrl}');`}
        >
          <!-- Date badge in top right -->
          <div class="flex absolute top-6 right-6 text-white">
            <div class="text-right">
                <span class="text-sm block -mb-2">2024</span>
                <span class="text-6xl font-subheading opacity-75">OCT</span>
            </div>

            <div class="flex items-start gap-2">
              <span class="border-l border-white h-full ml-1"></span>
              <div class="text-xs leading-tight -ml-1">
                <div class="text-sm -mb-2">No.</div>
                <div class="text-6xl font-subheading opacity-75">178</div>
              </div>
            </div>
          </div>


          <!-- Headline block -->
          <div class="w-full px-4">
            <h1 class="text-[#00b1ff] text-right inline-block leading-[0.75] uppercase mb-20">
              <span class="block text-[4.5rem] font-extrabold tracking-tight font-knockout p-0 m-0">
                {line1}
              </span>
              <span class="block relative text-[5rem] font-medium tracking-[0.02em] font-subheading mt-2 p-0 m-0">
                <span class="absolute left-0  w-36 h-1 bg-[#14c682] p-0 m-0"></span>
                {line2}
              </span>
            </h1>
            <ul class="tracking-wide">
              {teaserStories.map(story => (
                  <li class="font-subheading text-3xl uppercase mb-3">{story.title}</li>
              ))}
            </ul>
          </div>
        </section>

      )}

      <!-- Featured Stories -->
      <section class="bg-gray-800 p-6 ">
        <h2 class="font-body text-1xl uppercase tracking-widest mb-4 text-[#14c682]">Featured Stories</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- this is ome astro with jsx in it -->

          {featuredStories.map(story => {
            const sizes = story.featuredImage?.node?.mediaDetails?.sizes;

           

            const thumb = sizes?.find(size => size.name === "medium")?.sourceUrl
              ?? story.featuredImage?.node?.sourceUrl;

            return (
              <article>
                <img src={story.featuredImage?.node?.mediaDetails?.sizes?.find(size => size.name === "story-thumb")?.sourceUrl ?? story.featuredImage?.node?.sourceUrl
          } alt={story.title} class="..." />
                <h3 class="my-2 font-subheading text-2xl uppercase">{story.title}</h3>
                <p class="mb-2">
                  {story.excerpt.replace(/<[^>]*>/g, '').split(' ').slice(0, 30).join(' ') + '...'}
                </p>
                <a class="text-[#14c682]" href={`/blog-post/${story.slug}`}>Read more</a>
              </article>
            );
          })}
        </div>
      </section>
    </section>
  </div>
</Layout>
