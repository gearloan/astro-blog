---
import Layout from '@/layouts/Layout.astro';
import Sidebar from '@/components/magazine/Sidebar.astro';
import { resolveProseStyle } from '@/lib/resolveProseStyle.js';
import { gql } from 'graphql-request';
import { wp } from '@/lib/wp';
import { getPost } from '@/lib/queries/postBySlug';
import { pickMediaComponent } from '@/lib/mediaComponent';

export async function getStaticPaths() {
  const SLUGS = gql`
    query Slugs {
      posts(first: 100, where: { status: PUBLISH, orderby: { field: DATE, order: DESC } }) {
        nodes { slug }
      }
    }
  `;
  const data = await wp(SLUGS);
  return (data?.posts?.nodes ?? []).map((p: any) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const { postBy: post } = await getPost(slug);
if (!post) throw new Error(`Post not found: ${slug}`);

const Media = pickMediaComponent(post.formatSlug ?? 'longform');
const postForStyle = { ...post, contentGroups: post.contentGroups ?? { nodes: post.categories?.nodes ?? [] } };
const proseStyle = resolveProseStyle(postForStyle);

// Publication meta from tags (unchanged)
const tags = post.tags?.nodes ?? [];
const pub = tags.find((t: any) => ['turbine', 'pilot'].includes(t.slug))?.slug ?? 'pilot';
const publicationMeta = {
  pilot:   { title: 'Pilot Magazine',         issueInfo: 'Apr 2025 | No. 178', coverImg: '/images/proxy/pilot-mag.jpg',   bgColor: '#003440' },
  turbine: { title: 'Pilot Turbine Magazine', issueInfo: 'Apr 2025 | No. 89',  coverImg: '/images/proxy/turbine-mag.jpg', bgColor: '#00478c' },
};
const sidebarMeta = publicationMeta[pub] ?? publicationMeta.pilot;

// Best featured image convenience field for media components
const sizes = post?.featuredImage?.node?.mediaDetails?.sizes ?? [];
post.featuredImageUrl =
  sizes.find((s: any) => s.name === 'large')?.sourceUrl ??
  post?.featuredImage?.node?.sourceUrl ??
  null;
---
<Layout section="magazine" wrapperClass="bg-gray-900 text-amber-50" magazineTitle={post.title}>
  <div class="mx-auto px-0 md:px-8">
    <div class="grid min-h-screen grid-cols-1 items-start gap-0 bg-white md:grid-cols-[250px_1fr]">
      <Sidebar
        publicationTitle={sidebarMeta.title}
        issueInfo={sidebarMeta.issueInfo}
        coverImg={sidebarMeta.coverImg}
        bgColor={sidebarMeta.bgColor}
      />

      <article class={`prose max-w-none ${proseStyle}`}>
        <!-- Page-owned header -->
        <header class="mb-8">
          <span class="pb-0 pr-0 pl-4 md:pl-10 font-subheading text-2xl text-aopa-ltblue relative left-0 top-8 tracking-widest border-b-4 border-aopa-ltblue">
            FEATURE
          </span>
          <h1 class="pl-4 md:pl-10 font-heading uppercase text-[clamp(2rem,10vw,4rem)] break-words leading-none tracking-tight pt-24">
            {post.title}
          </h1>
          <p class="text-sm tpl-4 md:pl-10 text-sm text-slate-600">
            By {post.author?.node?.name} Â· {new Date(post.date).toLocaleDateString()}
          </p>
        </header>

        <!-- Type-specific media slot -->
        <section class="mb-8">
          <Media post={post} />
        </section>

        <!-- Page-owned body -->
        <div class="article-body dropcap px-4 md:px-10 lg:pr-56" set:html={post.content} />
      </article>
    </div>
  </div>
</Layout>
