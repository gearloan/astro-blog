---
import Layout from '../../layouts/Layout.astro';
import { resolveProseStyle } from '../../lib/resolveProseStyle.js';

export async function getStaticPaths() {
  const res = await fetch('https://aopa-porkbuns.sbs/graphql', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: `
        query {
          posts(first: 100) {
            nodes {
              slug
            }
          }
        }
      `,
    }),
  });

  const { data } = await res.json();
  if (!data?.posts?.nodes) throw new Error('Invalid GraphQL response');

  return data.posts.nodes.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;

// Fetch post by slug
const res = await fetch('https://aopa-porkbuns.sbs/graphql', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: `
      query ($slug: String!) {
        postBy(slug: $slug) {
          title
          content
          postPresentationSettings {
            proseStyle
          }
          featuredImage {
            node {
              mediaDetails {
                sizes {
                  name
                  sourceUrl
                }
              }
            }
          }
        }
      }
    `,
    variables: { slug },
  }),
});

const { data } = await res.json();
const post = data?.postBy;
if (!post) throw new Error(`Post not found for slug: ${slug}`);

// Find a nice featured image variant
const sizes = post.featuredImage?.node?.mediaDetails?.sizes;
const featured_image =
  sizes?.find((s) => s.name === 'large')?.sourceUrl ??
  sizes?.[0]?.sourceUrl ??
  null;

const proseStyle = resolveProseStyle(post);
---

<Layout section="magazine">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 md:grid-cols-[250px_1fr] gap-10 min-h-screen items-start">
      <!-- Magazine sidebar -->
      <aside class="sticky top-[75px] self-start h-[calc(100vh-75px)] bg-[#00677f] flex flex-col items-center text-white text-center p-6">
        <img src="/images/ui/logo-small-white.svg" alt="Logo" class="px-10 block dark:hidden my-6" />
        <div class="text-sm uppercase tracking-widest mb-1">Pilot Magazine</div>
        <div class="text-sm font-light tracking-wide mb-4">Feb 2025 | No. 178</div>
        <img src="/images/cover.jpg" alt="Cover" class="rounded shadow-lg mt-8" />
        <p class="mt-12">12/18 <br /> stories read</p>
        <div class="w-full px-6 my-2">
          <div class="w-full h-4 bg-gray-300 rounded-full shadow-inner relative overflow-hidden">
            <div class="h-full w-[35%] bg-[#00bcd4] rounded-full shadow-[0_2px_4px_rgba(0,0,0,0.3)]"></div>
          </div>
        </div>
      </aside>



      <!-- Main article content -->
      <article class={`prose ${proseStyle} max-w-none pt-24`}>
        <header class="mb-8">
          <h1 class="font-heading uppercase text-6xl tracking-tight" set:html={post.title}></h1>
          <p class="text-sm">By <b>Melissa Calvert</b></p>
          {featured_image && (
            <img src={featured_image} alt={post.title} class="w-full my-4" />
          )}
        </header>

        <div class="lg:pr-36" set:html={post.content}></div>
      </article>



    </div>
  </div>
</Layout>
